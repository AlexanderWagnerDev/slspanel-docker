{% extends 'base.html' %}
{% load i18n %}
{% block title %}{% trans "Streams on SLS-Live-Server" %}{% endblock %}

{% block content %}
<h1>{% trans 'Streams on SLS-Live-Server' %}</h1>
<a class="btn btn-outline-light mb-3" href="{% url 'streams:logout' %}">{% trans 'Logout' %}</a>
<a href="{% url 'streams:create_stream' %}" class="btn btn-success mb-3">{% trans 'Create Stream' %}</a>

{% if streams %}
<div class="accordion accordion-flush" id="streamAccordion">
    {% for stream in streams %}
    <div class="accordion-item bg-dark">
        <h2 class="accordion-header" id="heading{{ forloop.counter }}">
            <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="false"
                aria-controls="collapse{{ forloop.counter }}">
                <span class="blur-text" tabindex="0" role="button" aria-label="{% trans 'Live Publisher Key' %}"
                    onclick="copyToClipboard(this)" onkeyup="if(event.key==='Enter') copyToClipboard(this)"
                    data-url="{{ stream.publisher }}">
                    {{ stream.publisher }}
                </span>
                <span class="copy-feedback" aria-live="polite" aria-atomic="true"></span>
            </button>
        </h2>
        <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse"
            aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#streamAccordion">
            <div class="accordion-body">

                {% if stream.description %}
                <div class="mb-2">
                    <span class="text-muted">{% trans "Description" %}:</span>
                    {{ stream.description }}
                </div>
                {% endif %}

                <h5>{% trans 'Stream URLs' %}</h5>
                <ul>
                    <li>
                        {% trans "SRT Publish URL" %}:
                        <span class="copy-text" tabindex="0" role="button" aria-label="{% trans 'Copy SRT Publish URL' %}"
                              data-url="srt://{{ sls_domain_ip }}:{{ srt_publish_port }}?streamid={{ stream.publisher }}"
                              onclick="copyToClipboard(this)" onkeyup="if(event.key==='Enter') copyToClipboard(this)">
                            srt://{{ sls_domain_ip }}:{{ srt_publish_port }}?streamid={{ stream.publisher }}
                        </span>
                        <span class="copy-feedback" aria-live="polite" aria-atomic="true"></span>
                    </li>
                    <li>
                        {% trans "SRTLA Publish URL" %}:
                        <span class="copy-text" tabindex="0" role="button" aria-label="{% trans 'Copy SRTLA Publish URL' %}"
                              data-url="srtla://{{ sls_domain_ip }}:{{ srtla_publish_port }}?streamid={{ stream.publisher }}"
                              onclick="copyToClipboard(this)" onkeyup="if(event.key==='Enter') copyToClipboard(this)">
                            srtla://{{ sls_domain_ip }}:{{ srtla_publish_port }}?streamid={{ stream.publisher }}
                        </span>
                        <span class="copy-feedback" aria-live="polite" aria-atomic="true"></span>
                    </li>
                </ul>

                <h5>{% trans 'Players' %}</h5>
                {% if stream.player %}
                <ul class="list-group list-group-flush">
                    {% for player in stream.player %}
                    <li class="list-group-item bg-secondary bg-opacity-20 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>
                                <span class="blur-text" tabindex="0" role="button" aria-label="{% trans 'Player Key' %}"
                                      data-url="{{ player }}" onclick="copyToClipboard(this)"
                                      onkeyup="if(event.key==='Enter') copyToClipboard(this)">
                                    {{ player }}
                                </span>
                                <span class="copy-feedback" aria-live="polite" aria-atomic="true"></span>
                            </strong>
                            <form method="post" action="{% url 'streams:delete_player' player %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-danger">{% trans 'Delete' %}</button>
                            </form>
                        </div>
                        <div class="mt-2">
                            {% trans "Player URL" %}:
                            <span class="copy-text" tabindex="0" role="button" aria-label="{% trans 'Copy Player URL' %}"
                                  data-url="srt://{{ sls_domain_ip }}:{{ srt_player_port }}?streamid={{ player }}"
                                  onclick="copyToClipboard(this)" onkeyup="if(event.key==='Enter') copyToClipboard(this)">
                                srt://{{ sls_domain_ip }}:{{ srt_player_port }}?streamid={{ player }}
                            </span>
                            <span class="copy-feedback" aria-live="polite" aria-atomic="true"></span><br>
                            {% trans "Stats URL" %}:
                            <span class="copy-text" tabindex="0" role="button" aria-label="{% trans 'Copy Stats URL' %}"
                                  data-url="http://{{ sls_domain_ip }}:{{ sls_stats_port }}/stats/{{ player }}"
                                  onclick="copyToClipboard(this)" onkeyup="if(event.key==='Enter') copyToClipboard(this)">
                                http://{{ sls_domain_ip }}:{{ sls_stats_port }}/stats/{{ player }}
                            </span>
                            <span class="copy-feedback" aria-live="polite" aria-atomic="true"></span><br>
                            {% trans "Stats Legacy URL" %}:
                            <span class="copy-text" tabindex="0" role="button" aria-label="{% trans 'Copy Stats Legacy URL' %}"
                                  data-url="http://{{ sls_domain_ip }}:{{ sls_stats_port }}/stats/{{ player }}?legacy=1"
                                  onclick="copyToClipboard(this)" onkeyup="if(event.key==='Enter') copyToClipboard(this)">
                                http://{{ sls_domain_ip }}:{{ sls_stats_port }}/stats/{{ player }}?legacy=1
                            </span>
                            <span class="copy-feedback" aria-live="polite" aria-atomic="true"></span>
                        </div>
                        <div id="stats-{{ player }}" data-player-key="{{ player }}">
                            <p>{% trans 'Loading stats...' %}</p>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p><em>{% trans 'No players found' %}</em></p>
                {% endif %}

                <form method="post" action="{% url 'streams:delete_stream' stream.publisher %}" class="mt-3">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">{% trans 'Delete Stream' %}</button>
                </form>
                <form method="post" action="{% url 'streams:add_player' %}">
                    {% csrf_token %}
                    <input type="hidden" name="publisher_key" value="{{ stream.publisher }}">
                    <button type="submit" class="btn btn-primary mt-3">{% trans 'Add Player' %}</button>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p>{% trans 'No streams found' %}</p>
{% endif %}
{% endblock %}
